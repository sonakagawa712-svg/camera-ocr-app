<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>カメラOCRアプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5.0.0/dist/tesseract.min.js'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

    <div class="w-full max-w-xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8">
        <h1 class="text-3xl md:text-4xl font-bold text-center mb-6 text-gray-800">カメラOCRアプリ</h1>
        <p class="text-center text-sm md:text-base text-gray-600 mb-8">カメラでMTMとSNを読み取ります。</p>

        <!-- ビデオ要素とキャンバス -->
        <div class="relative w-full aspect-video bg-gray-200 rounded-lg overflow-hidden mb-6">
            <video id="video" class="w-full h-full object-cover" playsinline></video>
            <canvas id="canvas" class="hidden"></canvas>
            <!-- ビデオが読み込まれていない場合のプレースホルダー -->
            <div id="video-placeholder" class="absolute inset-0 flex items-center justify-center bg-gray-200 text-gray-500">
                <i class="fas fa-video text-5xl"></i>
            </div>
        </div>

        <!-- 読み込み中表示 -->
        <div id="loading" class="hidden text-center text-blue-500 mb-4">
            <i class="fas fa-spinner animate-spin mr-2"></i>
            <span>読み込み中...</span>
        </div>

        <!-- ボタンコンテナ -->
        <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 mb-6">
            <button id="capture-button" class="w-full md:w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors duration-300">
                <i class="fas fa-camera mr-2"></i>
                撮影して文字を認識
            </button>
        </div>

        <!-- 結果表示エリア -->
        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
            <!-- MTM -->
            <div class="flex-1 min-w-0 bg-white p-3 rounded-md border border-gray-300">
                <p class="text-xs text-gray-500 font-semibold mb-1">MTM:</p>
                <p id="mtm-text" class="text-gray-800 whitespace-pre-wrap break-words">認識結果がここに表示されます。</p>
            </div>
            
            <!-- SN -->
            <div class="flex-1 min-w-0 bg-white p-3 rounded-md border border-gray-300">
                <p class="text-xs text-gray-500 font-semibold mb-1">SN:</p>
                <p id="sn-text" class="text-gray-800 whitespace-pre-wrap break-words">認識結果がここに表示されます。</p>
            </div>
            
            <button id="copy-all-button" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors duration-300">
                <i class="fas fa-copy mr-2"></i>
                すべてコピー
            </button>
            <a id="spreadsheet-link" href="https://docs.google.com/spreadsheets/d/1-jjetvbMxOftWSw4nyL3u_OfcUURlEISFcSX3sBjvG0/edit?gid=0#gid=0" target="_blank" class="w-full block text-center bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors duration-300">
                <i class="fas fa-file-excel mr-2"></i>
                スプレッドシートへ
            </a>
        </div>

        <!-- メッセージボックス -->
        <div id="message-box" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 hidden bg-gray-800 text-white text-center py-2 px-4 rounded-full shadow-lg">
            テキストがコピーされました！
        </div>

    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureButton = document.getElementById('capture-button');
        const mtmText = document.getElementById('mtm-text');
        const snText = document.getElementById('sn-text');
        const copyAllButton = document.getElementById('copy-all-button');
        const loading = document.getElementById('loading');
        const videoPlaceholder = document.getElementById('video-placeholder');
        const messageBox = document.getElementById('message-box');
        
        let stream = null;
        let cameraStarted = false;

        // カメラを起動
        async function startCamera() {
            try {
                const constraints = {
                    video: {
                        facingMode: {
                            ideal: 'environment'
                        }
                    }
                };
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    videoPlaceholder.classList.add('hidden');
                };
            } catch (err) {
                console.error("カメラの起動に失敗しました: ", err);
                mtmText.textContent = "カメラの起動に失敗しました。";
                snText.textContent = "ブラウザでカメラへのアクセスを許可してください。";
            }
        }
        
        // カメラの映像から画像をキャプチャし、OCRを実行
        captureButton.addEventListener('click', async () => {
            if (!cameraStarted) {
                await startCamera();
                cameraStarted = true;
                setTimeout(() => {
                    captureAndRecognize();
                }, 500);
                return;
            }
            captureAndRecognize();
        });
        
        async function captureAndRecognize() {
            if (!stream) {
                mtmText.textContent = "カメラが起動していません。";
                snText.textContent = "";
                return;
            }
            
            loading.classList.remove('hidden');
            mtmText.textContent = '';
            snText.textContent = '';

            const context = canvas.getContext('2d');
            const videoWidth = video.videoWidth;
            const videoHeight = video.videoHeight;
            canvas.width = videoWidth;
            canvas.height = videoHeight;
            context.drawImage(video, 0, 0, videoWidth, videoHeight);

            try {
                const { data: { text } } = await Tesseract.recognize(
                    canvas,
                    'jpn+eng',
                    { logger: m => console.log(m) }
                );

                const sanitizedText = sanitizeText(text);
                const extractedInfo = extractSpecificInfo(sanitizedText);
                mtmText.textContent = extractedInfo.mtm || '見つかりませんでした。';
                snText.textContent = extractedInfo.sn || '見つかりませんでした。';

            } catch (err) {
                console.error("OCRエラー: ", err);
                mtmText.textContent = "OCR処理中にエラーが発生しました。";
                snText.textContent = "";
            } finally {
                loading.classList.add('hidden');
            }
        }
        
        function sanitizeText(text) {
            text = text.replace(/①/g, '1');
            text = text.replace(/②/g, '2');
            text = text.replace(/③/g, '3');
            text = text.replace(/④/g, '4');
            text = text.replace(/⑤/g, '5');
            text = text.replace(/⑥/g, '6');
            text = text.replace(/⑦/g, '7');
            text = text.replace(/⑧/g, '8');
            text = text.replace(/⑨/g, '9');
            text = text.replace(/⑩/g, '10');
            return text;
        }

        function extractSpecificInfo(text) {
            const lines = text.split('\n');
            let mtm = '';
            let sn = '';
            
            const mtmRegex = /MTM\s*[:]?\s*(.*)/i;
            const snRegex = /\(S\)?\s*SN\s*[:]?\s*(.*)/i;

            lines.forEach(line => {
                const mtmMatch = line.match(mtmRegex);
                if (mtmMatch && mtmMatch[1] && !mtm) {
                    mtm = mtmMatch[1].trim();
                }
                const snMatch = line.match(snRegex);
                if (snMatch && snMatch[1] && !sn) {
                    sn = snMatch[1].trim();
                }
            });
            return { mtm, sn };
        }

        // コピーボタンのクリックイベント
        copyAllButton.addEventListener('click', () => {
            const mtm = mtmText.textContent;
            const sn = snText.textContent;
            const combinedText = `${mtm}\t${sn}`; // タブで区切って横に並べる

            if (mtm === '見つかりませんでした。' && sn === '見つかりませんでした。') {
                return;
            }

            // クリップボードにコピー
            navigator.clipboard.writeText(combinedText).then(() => {
                showMessageBox('テキストがコピーされました！');
            }).catch(err => {
                console.error('コピーに失敗しました', err);
                showMessageBox('コピーに失敗しました。');
            });
        });

        function showMessageBox(message) {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 2000);
        }
    </script>
</body>
</html>
